<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link href="lib/bootstrap/dist/css/bootstrap.css" rel="stylesheet" />
    <script src="lib/jquery/dist/jquery.js"></script>
    <style>
        table a,
        table img {
            cursor: pointer;
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <div class="form-group">
            <label for="Category">Category</label>
            <select title="" name="" id="category" onchange="getProduct2()">
            </select>
        </div>
        <div class="form-group">
            <label for="Category">Name</label>
            <select title="" name="" id="sort" onchange="sort()">
                <option value="1">A-Z</option>
                <option value="2">Z-A</option>>
            </select>

            <input type="text" name="" id="search">

        </div>
        <div class="form-group" id="stuid">

        </div>
        <a href="AddProduct.html" class="btn btn-sm btn-primary">Add Product</a>
        <table class="table table-sm table-striped table-bordered m-2">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th onclick="order()">Unit price</th>
                    <th>Category</th>
                    <th>Update</th>
                    <th>Delete</th>
                </tr>

            </thead>
            <tbody id="table"></tbody>
        </table>
    </div>
    <script type="text/javascript">
        var list;
        $(document).ready(() => {
            getCategory();
            getProduct();
        });
        var check = false;
        var order = () => {
            if (check) { list.sort((b, a) => a.unitPrice - b.unitPrice); check = false; }
            else { list.sort((b, a) => b.unitPrice - a.unitPrice); check = true; }
            loadDataProductToView(list);
        }

        var sort = () => {
            var ss = $('#sort').val();
            if (ss == 1) {
                list.sort((a, b) => a.productName.localeCompare(b.productName));
            } else if (ss == 2) {
                list.sort((a, b) => b.productName.localeCompare(a.productName));
            }
            loadDataProductToView(list);

        }


        var getCategory = () => $.ajax({
            url: 'http://localhost:5000/api/Category',
            type: 'GET',
            headers: {
                "Content-type": "application/json"
            },
            success: (data) => loadDataCategoryToView(data),
            error: () => { alert('error'); }
        });

        const loadDataCategoryToView = (data) => {
            data.forEach(item => {
                $('#category').append(`<option value="${item.categoryId}">${item.categoryName}</option>`);
            });
        };

        var getProduct2 = () => $.ajax({
            url: `http://localhost:5000/api/Product/id?id=${$('#category').val()}`,
            type: 'GET',
            headers: {
                "Content-type": "application/json"
            },
            success: (data) => loadDataProductToView(data),
            error: () => { alert('error'); }
        });

        var getProduct = () => $.ajax({
            url: 'http://localhost:5000/api/Product',
            type: 'GET',
            headers: {
                "Content-type": "application/json"
            },
            success: (data) => { loadDataProductToView(data); list = data; loadDataIDToView(data) },
            error: () => { alert('error'); }
        });

        var search = () => $.ajax({
            url: `http://localhost:5000/api/Product/search?name=${$('#search').val()}`,
            type: 'GET',
            headers: {
                "Content-type": "application/json"
            },
            success: (data) => { loadDataProductToView(data); list = data; loadDataIDToView(data) },
            error: () => { alert('error'); }
        });

        var loadDataIDToView = (data) => {
            $('#stuid').empty();
            data.forEach(item => {
                var json = JSON.stringify(item);
                var html = `<td onclick='editProduct(${item.productId})'><button class="btn-primary">${item.productId}</button>
                    </td>`;
                $('#stuid').append(html);
            });
        };

        var loadDataProductToView = (data) => {
            $('#table').empty();
            data.forEach(item => {
                var json = JSON.stringify(item);
                var html = `
                    <tr>
                        <td>${item.productId}</td>
                        <td>${item.productName}</td>
                        <td>${item.unitPrice}</td>
                        <td>${item?.category?.categoryName}</td>
                        <td>
                            <img src='./icon/edit.png' onclick='editProduct(${item.productId})'
                                style="
                                width: 20px;
                                 height: 20px;
                            ">
                        </td>
                        <td>
                            <img src='./icon/close.png' onclick='deleteProduct(${item.productId})'
                                style="
                                    width: 20px;
                                    height: 20px;
                            ">
                        </td>
                    </tr>`;
                $('#table').append(html);
            });
        };

        var editProduct = (id) => {
            localStorage.setItem("proId", id);
            // location.href = 'EditProduct.html';
            location.href = `EditProduct.html?id=${id}`;
        };

        var deleteProduct = (id) => $.ajax({
            url: `http://localhost:5000/api/Product/id?id=${id}`,
            type: 'DELETE',
            headers: {
                "Content-type": "application/json"
            },
            success: () => getProduct(),
            error: () => { alert('error'); }
        });

    </script>
</body>

</html>